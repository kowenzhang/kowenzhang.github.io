
 <!DOCTYPE HTML>
<html lang="auto_detect">
<head>
  <meta charset="UTF-8">
  
    <title>Ubuntu16.04安装StrongSwan VPN教程 | Do cool things for fun</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="kowen">
    

    
    <meta name="description" content="by kowen 本文讲述了如何在Ubuntu16.04服务器上部署基于IKEv2的VPN服务，主要内容翻译自How to Set Up an IKEv2 VPN Server with StrongSwan on Ubuntu 16.04。斜体部分是我的画蛇添足，在windows、ios亲测完全正常可用。">
<meta name="keywords" content="ubuntu,VPN,科学上网,StrongSwan">
<meta property="og:type" content="article">
<meta property="og:title" content="Ubuntu16.04安装StrongSwan VPN教程">
<meta property="og:url" content="www.kowen.cn/2017/09/14/Ubuntu16-04-安装StrongSwan-VPN教程/index.html">
<meta property="og:site_name" content="Do cool things for fun">
<meta property="og:description" content="by kowen 本文讲述了如何在Ubuntu16.04服务器上部署基于IKEv2的VPN服务，主要内容翻译自How to Set Up an IKEv2 VPN Server with StrongSwan on Ubuntu 16.04。斜体部分是我的画蛇添足，在windows、ios亲测完全正常可用。">
<meta property="og:locale" content="auto_detect">
<meta property="og:updated_time" content="2019-04-08T09:06:12.054Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ubuntu16.04安装StrongSwan VPN教程">
<meta name="twitter:description" content="by kowen 本文讲述了如何在Ubuntu16.04服务器上部署基于IKEv2的VPN服务，主要内容翻译自How to Set Up an IKEv2 VPN Server with StrongSwan on Ubuntu 16.04。斜体部分是我的画蛇添足，在windows、ios亲测完全正常可用。">

    
    <link rel="alternative" href="/atom.xml" title="Do cool things for fun" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/funcool_logo_32X32.ico">
    
    
    <link rel="apple-touch-icon" href="/img/funcool_logo_114X114.png">
    <link rel="apple-touch-icon-precomposed" href="/img/funcool_logo_114X114.png">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/funcool_logo.svg" alt="Do cool things for fun" title="Do cool things for fun"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Do cool things for fun">Do cool things for fun</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
						<form class="search" action="http://search.kowen.cn/cse/search" target="_blank">
							<label>Search</label>
						<input name="s" type="hidden" value= 12712694625790015895 ><input type="text" name="q" size="30" placeholder="Search"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/09/14/Ubuntu16-04-安装StrongSwan-VPN教程/" title="Ubuntu16.04安装StrongSwan VPN教程" itemprop="url">Ubuntu16.04安装StrongSwan VPN教程</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="kowen" target="_blank" itemprop="author">kowen</a>
		
  <p class="article-time">
    <time datetime="2017-09-14T02:18:00.000Z" itemprop="datePublished"> Published 2017-09-14</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#介绍"><span class="toc-number">1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#前提"><span class="toc-number">2.</span> <span class="toc-text">前提</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一、安装strongSwan"><span class="toc-number">3.</span> <span class="toc-text">一、安装strongSwan</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、建立认证中心"><span class="toc-number">4.</span> <span class="toc-text">二、建立认证中心</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、为VPN服务器生成证书"><span class="toc-number">5.</span> <span class="toc-text">三、为VPN服务器生成证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、配置StrongSwan"><span class="toc-number">6.</span> <span class="toc-text">四、配置StrongSwan</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、配置VPN登录验证"><span class="toc-number">7.</span> <span class="toc-text">五、配置VPN登录验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六、配置防火墙和IP转发"><span class="toc-number">8.</span> <span class="toc-text">六、配置防火墙和IP转发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#七、测试连接"><span class="toc-number">9.</span> <span class="toc-text">七、测试连接</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#windows连接"><span class="toc-number">9.1.</span> <span class="toc-text">windows连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IOS连接"><span class="toc-number">9.2.</span> <span class="toc-text">IOS连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#macOS连接"><span class="toc-number">9.3.</span> <span class="toc-text">macOS连接</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常见问题"><span class="toc-number">10.</span> <span class="toc-text">常见问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">11.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#翻译结语"><span class="toc-number">12.</span> <span class="toc-text">翻译结语</span></a></li></ol>
		
		</div>
		
		<p>by <a href="http://www.kowen.cn">kowen</a></p>
<p>本文讲述了如何在Ubuntu16.04服务器上部署基于IKEv2的VPN服务，主要内容翻译自<a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-ikev2-vpn-server-with-strongswan-on-ubuntu-16-04" target="_blank" rel="noopener">How to Set Up an IKEv2 VPN Server with StrongSwan on Ubuntu 16.04</a>。<br><em>斜体部分是我的画蛇添足，在windows、ios亲测完全正常可用。</em></p>
<a id="more"></a>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><em>介绍看不懂的可以不看</em></p>
<p>VPN连接英文全名叫virtual private network，即虚拟专用网络，有了它你可以在一些不安全的网络（比如咖啡馆、机场的公共wifi接入网络）中实现可靠的加密信息传输。 <em>当然，国内最多的用途当然就是科学上网了</em></p>
<p>IKEv2,英文全称Internet Key Exchange v2，是一个让客户端服务器建立直接IPSec通道连接的协议。在基于IKEv2的 VPN中，IPSec为网络传输提供加密功能。<strong>IKEv2在OS X10.11+ IOS 9.1+ 和windows10中默认支持，不用安装其他软件</strong> <em>所以苹果手机也可以很方便的使用哦</em></p>
<p>本文将教你如何在ubuntu16.04服务器上使用<a href="https://www.strongswan.org/" target="_blank" rel="noopener">StrongSwan</a>建立一个IKEv2 VPN服务器，并在windows、IOS和mac客户端上连接。</p>
<h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h2><p>你需要做以下准备：</p>
<ul>
<li>一台Ubuntu16.04服务器，按照<a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-16-04" target="_blank" rel="noopener">the Ubuntu 16.04 initial server setup guide</a>配置好，包括一个执行sudo命令的非root用户和防火墙。<em>特殊需求的用户服务器可以用<a href="https://www.sugarhosts.com/zh-cn/" target="_blank" rel="noopener">糖果主机</a>之类的vps, 不用个人配置，直接给你克隆好，包月40左右，英文不好的可以用糖果，网站是中文，服务人员也用中文，去度娘吧不多说了。另外，我直接用root用户配的</em>    </li>
</ul>
<p>另外，你需要先了解一下IPTables，你可以学习一下 <a href="https://www.digitalocean.com/community/tutorials/how-the-iptables-firewall-works" target="_blank" rel="noopener">How the Iptables Firewall Works </a>   <em>中文的教程：<a href="http://www.kowen.cn/2015/11/13/iptables/">iptables中文简明教程</a></em></p>
<h2 id="一、安装strongSwan"><a href="#一、安装strongSwan" class="headerlink" title="一、安装strongSwan"></a>一、安装strongSwan</h2><p>首先需要安装StrongSwan，它是一个开源的IPSec后台服务，在此我们把它配制成一个VPN服务器。不建议使用基于证书的登录验证方式，最好使用基于密码的客户端验证登录，使用StrongSwan EAP插件可以帮我们实现密码登录功能。还需要设置一些防火墙规则，所以我们还要安装一个保存防火墙规则的工具<em>防止重启后规则丢失</em></p>
<p>在服务器上执行以下命令安装上述程序<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">sudo</span> apt-<span class="meta">get</span> update</div><div class="line"><span class="symbol">sudo</span> apt-<span class="meta">get</span> install <span class="keyword">strongswan </span><span class="keyword">strongswan-plugin-eap-mschapv2 </span>moreutils iptables-persistent</div></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>注意</strong>：安装过程中会提示是否要保存当前 IPv4和IPv6规则。因为我们想保留目前的防火墙规则不变，都选择是即可。</p>
</blockquote>
<p>安装完成后，下一步是建立证书</p>
<h2 id="二、建立认证中心"><a href="#二、建立认证中心" class="headerlink" title="二、建立认证中心"></a>二、建立认证中心</h2><p>IKEv2服务器需要证书来向客户端验证自己的身份，StrongSwan给我们提供了生成认证中心和服务器证书的工具来帮助我们创建所需的证书。首先我们来创建一个文件夹来保存下面生成的各种文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir vpn-certs</div><div class="line">cd vpn-certs</div></pre></td></tr></table></figure>
<p>文件夹创建好后，需要创建根密钥，这是一个4096位的RSA密钥，它的用途是给认证中心进行签名。这个密钥非常重要，所以我们只给root用户读权限，其他用户不能访问。生成密钥的命令如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ipsec pki --gen --type rsa --size 4096 --outform pem &gt; server-root-key.pem</div><div class="line">chmod 600 server-root-key.pem</div></pre></td></tr></table></figure></p>
<p>接下来，建立根认证中心，使用刚才创建的密钥对认证中心进行签名。<em>注意下面一大垛是一条命令，一块复制到Shell下执行</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ipsec pki --self --ca --lifetime 3650 \</div><div class="line">--in server-root-key.pem \</div><div class="line">--type rsa --dn &quot;C=US, O=VPN Server, CN=VPN Server Root CA&quot; \</div><div class="line">--outform pem &gt; server-root-ca.pem</div></pre></td></tr></table></figure></p>
<p>你可以修改DN参数后的国家C、组织O和CN名称(Common Name)，CN名称在这只是一个名称，你可以胡编乱造。<em>这个时候你可以在vpn-certs下看到生成了两个文件server-root-key.pem和server-root-ca.pem</em></p>
<p>等会我们将复制根证书server-root-ca.pem到我们的客户端，这样客户端连接时就可以验证服务器了。</p>
<p>到现在根认证中心已经建好并运行，下面创建VPN服务器使用的证书。</p>
<h2 id="三、为VPN服务器生成证书"><a href="#三、为VPN服务器生成证书" class="headerlink" title="三、为VPN服务器生成证书"></a>三、为VPN服务器生成证书</h2><p>为VPN服务器生成证书，这个证书用于客户端验证服务器的真实性。</p>
<p>首先为VPN服务器创建一个密钥<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ipsec pki --gen --type rsa --size 4096 --outform pem &gt; vpn-server-key.pem</div></pre></td></tr></table></figure></p>
<p>然后生成VPN服务器证书，用前面生成的认证中心的密钥对这个证书进行签名。先修改一下命令，把SERVER_NAME_OR_IP换成你服务器的DNS名称或者IP地址。<em>注意要替换两个SERVER_NAME_OR_IP,下面依然是一条命令</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">ipsec pki --pub --in vpn-server-key.pem \</div><div class="line">--type rsa | ipsec pki --issue --lifetime 1825 \</div><div class="line">--cacert server-root-ca.pem \</div><div class="line">--cakey server-root-key.pem \</div><div class="line">--dn &quot;C=US, O=VPN Server, CN=SERVER_NAME_OR_IP&quot; \</div><div class="line">--san SERVER_NAME_OR_IP \</div><div class="line">--flag serverAuth --flag ikeIntermediate \</div><div class="line">--outform pem &gt; vpn-server-cert.pem</div></pre></td></tr></table></figure>
<p>把证书拷贝到配置目录以便StrongSwan读取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo cp ./vpn-server-cert.pem /etc/ipsec.d/certs/vpn-server-cert.pem</div><div class="line">sudo cp ./vpn-server-key.pem /etc/ipsec.d/private/vpn-server-key.pem</div></pre></td></tr></table></figure>
<p>最后更改权限只允许root用户有读权限<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo chown root /etc/ipsec.d/private/vpn-server-key.pem</div><div class="line">sudo chgrp root /etc/ipsec.d/private/vpn-server-key.pem</div><div class="line">sudo chmod 600 /etc/ipsec.d/private/vpn-server-key.pem</div></pre></td></tr></table></figure></p>
<p>这样，我们已经建立了客户端和服务器安全通讯的证书对，还用根密钥对证书进行了签名以使客户端能验证VPN服务器的真实性。所有的证书文件都已准备好了，下面开始配置软件。</p>
<h2 id="四、配置StrongSwan"><a href="#四、配置StrongSwan" class="headerlink" title="四、配置StrongSwan"></a>四、配置StrongSwan</h2><p>前面步骤生成了所需要的证书，本节对StrongSwan进行配置。</p>
<p>StrongSwan有一个默认配置文件，在进行配置前，需要进行备份，以便搞错后进行恢复。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo cp /etc/ipsec.conf /etc/ipsec.conf.original</div></pre></td></tr></table></figure></p>
<p>默认配置文件相当长，为了防止配置出错，我们清除默认配置，从零开始写配置文件。首先，清除配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo &apos;&apos; | sudo tee /etc/ipsec.conf</div></pre></td></tr></table></figure></p>
<p><em>下面的步骤都是编辑配置文件，比较繁琐，本节最后有完整配置文件，建议本地编写好上传覆盖，完整配置文件中需要根据第5步修改@server_name_or_ip参数</em></p>
<p>然后编辑配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo nano /etc/ipsec.conf</div></pre></td></tr></table></figure></p>
<ol>
<li><p>首先开启StrongSwan的后台日志方便调试，允许多重连接。在文件中插入以下下几行：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">config</span> <span class="built_in">setup</span></div><div class="line">  charondebug=<span class="string">"ike 1, knl 1, cfg 0"</span></div><div class="line">  uniqueids=no</div></pre></td></tr></table></figure>
</li>
<li><p>建立VPN配置，让StrongSwan建立IKEv2通道并且在它启动时自动加载该配置，再加入以下几行： </p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">conn ikev2-vpn</div><div class="line">  <span class="attr">auto=add</span></div><div class="line">  <span class="attr">compress=no</span></div><div class="line">  <span class="attr">type=tunnel</span></div><div class="line">  <span class="attr">keyexchange=ikev2</span></div><div class="line">  <span class="attr">fragmentation=yes</span></div><div class="line">  <span class="attr">forceencaps=yes</span></div></pre></td></tr></table></figure>
</li>
<li><p>加入StrongSwan VPN需要支持的通讯加密算法，再加入以下几行：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attr">ike</span>=aes256-sha1-modp1024,<span class="number">3</span>des-sha1-modp1024!</div><div class="line"><span class="attr">esp</span>=aes256-sha1,<span class="number">3</span>des-sha1!</div></pre></td></tr></table></figure>
</li>
<li><p>启用断开连接探测清理掉线的连接，再加入以下几行：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attr">dpdaction</span>=clear</div><div class="line"><span class="attr">dpddelay</span>=<span class="number">300</span>s</div><div class="line"><span class="attr">rekey</span>=<span class="literal">no</span></div></pre></td></tr></table></figure>
</li>
<li><p>配置服务器端（left）IPSec参数，添加以下几行（<strong>注意：</strong> 当配置leftid时，只有通过域名连接VPN服务器时才写@符号，比如@vpn.example.com，IP地址不用@符号，比如111.111.111.111）：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="attr">left</span>=%any</div><div class="line"><span class="attr">leftid</span>=@server_name_or_ip</div><div class="line"><span class="attr">leftcert</span>=/etc/ipsec.d/certs/vpn-server-cert.pem</div><div class="line"><span class="attr">leftsendcert</span>=always</div><div class="line"><span class="attr">leftsubnet</span>=<span class="number">0.0</span>.<span class="number">0.0</span>/<span class="number">0</span></div></pre></td></tr></table></figure>
</li>
<li><p>配置客户端（right）IPSec参数，包括客户端连接后分配的IP地址段和DNS配置xxx</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="attr">right</span>=%any</div><div class="line"><span class="attr">rightid</span>=%any</div><div class="line"><span class="attr">rightauth</span>=eap-mschapv2</div><div class="line"><span class="attr">rightsourceip</span>=<span class="number">10.10</span>.<span class="number">10.0</span>/<span class="number">24</span></div><div class="line"><span class="attr">rightdns</span>=<span class="number">8.8</span>.<span class="number">8.8</span>,<span class="number">8.8</span>.<span class="number">4.4</span></div><div class="line"><span class="attr">rightsendcert</span>=never</div></pre></td></tr></table></figure>
</li>
<li><p>最后，配置StrongSwan向客户端要求用户证书：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attr">eap_identity</span>=%identity</div></pre></td></tr></table></figure>
</li>
</ol>
<p>完整的配置文件如下：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">config setup</div><div class="line">    charondebug=<span class="string">"ike 1, knl 1, cfg 0"</span></div><div class="line">    uniqueids=no</div><div class="line"></div><div class="line">conn ikev2-vpn</div><div class="line">    auto=add</div><div class="line">    compress=no</div><div class="line">    type=tunnel</div><div class="line">    keyexchange=ikev2</div><div class="line">    fragmentation=yes</div><div class="line">    forceencaps=yes</div><div class="line">    ike=aes256-sha1-modp1024,<span class="number">3</span>des-sha1-modp1024!</div><div class="line">    esp=aes256-sha1,<span class="number">3</span>des-sha1!</div><div class="line">    dpdaction=clear</div><div class="line">    dpddelay=<span class="number">300</span>s</div><div class="line">    rekey=no</div><div class="line">    left=%any</div><div class="line">    leftid=@server_name_or_ip</div><div class="line">    leftcert=/etc/ipsec.d/certs/vpn-server-cert.pem</div><div class="line">    leftsendcert=always</div><div class="line">    leftsubnet=<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span></div><div class="line">    right=%any</div><div class="line">    rightid=%any</div><div class="line">    rightauth=eap-mschapv2</div><div class="line">    rightdns=<span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span>,<span class="number">8.8</span><span class="number">.4</span><span class="number">.4</span></div><div class="line">    rightsourceip=<span class="number">10.10</span><span class="number">.10</span><span class="number">.0</span>/<span class="number">24</span></div><div class="line">    rightsendcert=never</div><div class="line">    eap_identity=%identity</div></pre></td></tr></table></figure>
<p>那么VPN参数配置完毕，下面介绍如何建立一个远程连接用户。</p>
<h2 id="五、配置VPN登录验证"><a href="#五、配置VPN登录验证" class="headerlink" title="五、配置VPN登录验证"></a>五、配置VPN登录验证</h2><p>到这里服务器已经可以接受客户端的连接了，但是我们还没有进行证书配置，证书配置文件是ipsec.secrets，这个文件的作用：</p>
<ul>
<li>告诉StrongSwan服务器证书私钥的位置，这样服务器才能加密解密传输的数据</li>
<li>建立VPN用户</li>
</ul>
<p>编辑配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo nano /etc/ipsec.secrets</div></pre></td></tr></table></figure></p>
<ol>
<li><p>告诉StrongSwan私钥的位置：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">server_name_or_ip : <span class="type">RSA</span> <span class="string">"/etc/ipsec.d/private/vpn-server-key.pem"</span></div></pre></td></tr></table></figure>
</li>
<li><p>建立用户登陆凭证（用户名密码），用户名和密码随意取，但是必须注明允许StrongSwan接受用户来自任意地址的连接 </p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">your_username %any% : <span class="type">EAP</span> <span class="string">"your_password"</span></div></pre></td></tr></table></figure>
</li>
<li><p>关闭保存文件，重新启动ipsec服务启用新的配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo ipsec reload</div></pre></td></tr></table></figure>
</li>
</ol>
<p>VPN服务器已经配置完毕，下面是最重要的一步：配置防火墙</p>
<h2 id="六、配置防火墙和IP转发"><a href="#六、配置防火墙和IP转发" class="headerlink" title="六、配置防火墙和IP转发"></a>六、配置防火墙和IP转发</h2><p>配置完VPN服务器后，需要对防火墙进行配置，以使防火墙允许和转发VPN流量。使用IPTables工具来实现。</p>
<ol>
<li><p>如果已经开启了UFW，先禁用，因为它会跟我们的配置冲突</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo ufw <span class="built_in">disable</span></div></pre></td></tr></table></figure>
</li>
<li><p>删除所有UFW留下的防火墙规则</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo iptables -P INPUT ACCEPT</div><div class="line">sudo iptables -P FORWARD ACCEPT</div><div class="line">sudo iptables -F</div><div class="line">sudo iptables -Z</div></pre></td></tr></table></figure>
</li>
<li><p>为了防止SSH连接断开，先允许目前的连接，然后打开22或者自己设定的SSH端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</div><div class="line">sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT</div></pre></td></tr></table></figure>
</li>
<li><p>允许本地回环地址的连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo iptables -A INPUT -i lo -j ACCEPT</div></pre></td></tr></table></figure>
</li>
<li><p>允许IPSec连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo iptables -A INPUT -p udp --dport  500 -j ACCEPT</div><div class="line">sudo iptables -A INPUT -p udp --dport 4500 -j ACCEPT</div></pre></td></tr></table></figure>
</li>
<li><p>设置IPTables转发ESp(Encapsulating Security Payload)流量。转发ESP流量，ESP可以在非可信网络中给我们VPN包增加额外保护。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo iptables -A FORWARD --match policy --pol ipsec --dir in  --proto esp -s 10.10.10.10/24 -j ACCEPT</div><div class="line">sudo iptables -A FORWARD --match policy --pol ipsec --dir out --proto esp -d 10.10.10.10/24 -j ACCEPT</div></pre></td></tr></table></figure>
</li>
<li><p>VPN服务器在客户端和网络之间扮演了网关的角色。因为VPN服务器只有一个公网IP，我们需要启用伪装让服务器代替客户端从互联网请求数据，这样就可以使数据在VPN客户端和服务器之间传输。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo iptables -t nat -A POSTROUTING -s 10.10.10.10/24 -o eth0 -m policy --pol ipsec --dir out -j ACCEPT</div><div class="line">sudo iptables -t nat -A POSTROUTING -s 10.10.10.10/24 -o eth0 -j MASQUERADE</div></pre></td></tr></table></figure>
</li>
<li><p>为了防止某些客户端的IP包拆分，设置IPTables包大小参数以减小包的大小，预防某些VPN客户端出问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo iptables -t mangle -A FORWARD --match policy --pol ipsec --dir in -s 10.10.10.10/24 -o eth0 -p tcp -m tcp --tcp-flags SYN,RST SYN -m tcpmss --mss 1361:1536 -j TCPMSS --set-mss 1360</div></pre></td></tr></table></figure>
</li>
<li><p>安全起见，禁止其他所有连接。<em>服务器上有其他服务的请用iptables工具打开相应端口</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo iptables -A INPUT -j DROP</div><div class="line">sudo iptables -A FORWARD -j DROP</div></pre></td></tr></table></figure>
</li>
<li><p><strong>保存防火墙配置，防止重启丢失</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo netfilter-persistent save</div><div class="line">sudo netfilter-persistent reload</div></pre></td></tr></table></figure>
</li>
<li><p>最后启用包转发功能，包转发用来将数据在服务器上从一个IP发送到另一个IP，实际上我们服务器就是一个转发器。编辑配置文件 /etc/sysctl.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo nano /etc/sysctl.conf</div></pre></td></tr></table></figure>
<p>需要配置的东西包括：</p>
<ul>
<li>启用IPv4转发</li>
<li>禁用Path MTU discovery防止包拆分问题</li>
<li>禁止接受和发送ICMP重定向，防止中间人攻击</li>
</ul>
<p>配置修改部分如下<em>（4个参数，前三个取消注释即可，最后一个自己添加）</em>：</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">. . .</div><div class="line"></div><div class="line"># Uncomment the next line to enable packet forwarding <span class="keyword">for</span> IPv4</div><div class="line"><span class="built_in">net</span>.ipv4.ip_forward=<span class="number">1</span></div><div class="line">. . .</div><div class="line"># <span class="keyword">Do</span> <span class="keyword">not</span> accept ICMP redirects (prevent MITM attacks)</div><div class="line"><span class="built_in">net</span>.ipv4.conf.all.accept_redirects = <span class="number">0</span></div><div class="line"># <span class="keyword">Do</span> <span class="keyword">not</span> send ICMP redirects (we are <span class="keyword">not</span> a router)</div><div class="line"><span class="built_in">net</span>.ipv4.conf.all.send_redirects = <span class="number">0</span></div><div class="line">. . .</div><div class="line"><span class="built_in">net</span>.ipv4.ip_no_pmtu_disc = <span class="number">1</span></div></pre></td></tr></table></figure>
</li>
<li><p>重启服务器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo reboot</div></pre></td></tr></table></figure>
</li>
</ol>
<p><em>服务器配置已经完成，如果客户端连接正常就大功告成了，下面是连接方法</em></p>
<h2 id="七、测试连接"><a href="#七、测试连接" class="headerlink" title="七、测试连接"></a>七、测试连接</h2><p>VPN服务器已经配置完毕，下面来测试一下是否能正常连接。首先要下载根证书到本地，安装到你的客户机上。有两种方式，命令行打印输出和远程下载。</p>
<ul>
<li>方式一、命令行输出<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat ~/vpn-certs/server-root-ca.pem</div></pre></td></tr></table></figure>
</li>
</ul>
<p>你会看到<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">----<span class="keyword">BEGIN</span> CERTIFICATE-----</span></div><div class="line">MIIFQjCCAyqgAwIBAgIIFkQGvkH4ej0wDQYJKoZIhvcNAQEMBQAwPzELMAkGA1UE</div><div class="line">. . .</div><div class="line">EwbVLOXcNduWK2TPbk/+82GRMtjftran6hKbpKGghBVDPVFGFT6Z0OfubpkQ9RsQ</div><div class="line">BayqOb/Q</div><div class="line">-<span class="ruby">----<span class="keyword">END</span> CERTIFICATE-----</span></div></pre></td></tr></table></figure></p>
<p>复制所有内容包括—–BEGIN CERTIFICATE—–和—–END CERTIFICATE—–到文字编辑器比如记事本，<br>然后保存，名称自己起，但后缀名必须是pem，比如vpn_root_certificate.pem。</p>
<ul>
<li>方式二、使用SFTP工具下载<br>不详述。</li>
</ul>
<p>一旦下载了根证书文件，就可以建立VPN连接了。<em>鸡动吧</em></p>
<h3 id="windows连接"><a href="#windows连接" class="headerlink" title="windows连接"></a>windows连接</h3><ul>
<li>首先导入根证书<ol>
<li>在运行中，输入mmc.exe，打开控制台窗口</li>
<li>从文件菜单中选择添加删除管理单元，弹出窗口中选择证书，添加</li>
<li>如果想要本地计算机所有用户都可以使用VPN连接，选择计算机账户，下一步</li>
<li>选择本地计算机，完成</li>
<li>依次展开证书-&gt;受信任的根证书办法机构（Trusted Root Certification Authorities)-证书</li>
<li>点击操作-&gt;所有任务-&gt;导入</li>
<li>选择证书文件vpn_root_certificate.pem，下一步</li>
<li>确认证书保存到收信人的根证书办法机构</li>
<li>完成导入成功。</li>
</ol>
</li>
<li>然后配置VPN连接<ol>
<li>打开控制面板，进入网络和共享中心</li>
<li>点击设置新的连接或网络，选择连接到工作区</li>
<li>选择使用我的Internet连接（VPN）</li>
<li>地址中输入服务器名称或者IP，目标名称可以随意起</li>
<li>输入用户名密码（ipsec.secret中配置的），域不填写，点击连接</li>
</ol>
</li>
</ul>
<p>创建后，你可以在网络列表中看到新建的VPN连接，选择然后点击连接，输入用户名密码即可连接。</p>
<h3 id="IOS连接"><a href="#IOS连接" class="headerlink" title="IOS连接"></a>IOS连接</h3><p>在苹果手机上连接VPN服务，请遵循一下步骤：</p>
<ol>
<li>把根证书文件作为附件发送到你的邮箱</li>
<li>用IOS登录邮箱，点击附件，点击安装，会要求输入你的ios密码，点击完成</li>
<li>打开“设置-&gt;通用-&gt;VPN”，点击添加VPN配置</li>
<li>类型选择 IKEv2</li>
<li>描述输入你给vpn连接起的名字</li>
<li>服务器和远程ID输入ip地址或域名，本地ID不用填</li>
<li>输入用户名、密码（ipsec.secret），点击完成</li>
<li>选择创建的vpn名称，点击连接</li>
</ol>
<h3 id="macOS连接"><a href="#macOS连接" class="headerlink" title="macOS连接"></a>macOS连接</h3><p><em>贫农没有mac，以下纯翻译，未验证，系统提示信息可能与实际不一致</em></p>
<ul>
<li><p>导入证书  </p>
<ol>
<li>双击证书文件，Keychain Access弹出窗口提示“Keychain Access试图更改系统keychain，输入密码允许”</li>
<li>输入密码，点击允许更改Keychain</li>
<li>双击导入的vpn证书，会弹出窗口指定信任级别，设置IP Security为Always Trust，再次输入密码，系统会自动保存配置。</li>
</ol>
</li>
<li><p>创建VPN连接</p>
<ol>
<li>进入系统设置（System Preference），选择网络</li>
<li>点击网络列表左下角加号按钮</li>
<li>弹出窗口中，设置接口为VPN， 配置VPN类型为IKEv2，给连接起一个名字</li>
<li>在服务器和远程ID中输入服务器域名或者IP，本地ID设置为空</li>
<li>点击认证设置，选择用户名，输入用户名密码，确定保存。</li>
</ol>
</li>
</ul>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><p>如果不能导入证书，请确认证书的后缀名是pem，而不是pem.txt或其他。</p>
<p>如果不能连接到VPN服务器，检查连接的服务器域名或地址是否正确。服务器的域名或IP地址必须和创建证书文件时配置的CN名称一致，否则vpn不能工作。比如你用CN参数为vpn.example.com建立证书，那你必须使用vpn.example.com来创建连接。执行生成证书命令和建立VPN连接时，要反复检查。</p>
<p>最后，检查VPN配置确保使用域名做leftid的时候前面一定要加@，使用IP时一定不加@。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">leftid = @vpn.example.com</div></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">leftid = 111.111.111.111</div></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>按照本教程你已经建立好了一个支持IKEv2协议的VPN服务器，现在你可以在任何地方使用你的加密连接（科学上网）了。</p>
<p>添加或删除用户，只需要遵照步骤5设置即可，每个用户单独占一行。</p>
<p>StrongSwan输出日志到syslog，也许你想配置一个日志分析器，可以查看这篇文章<a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-logwatch-log-analyzer-and-reporter-on-a-vps" target="_blank" rel="noopener"> How To Install and Use Logwatch Log Analyzer and Reporter on a VPS </a>。</p>
<h2 id="翻译结语"><a href="#翻译结语" class="headerlink" title="翻译结语"></a>翻译结语</h2><blockquote>
<p>防火墙中间有一步转发忘了翻译，结果能连接不能上网，折腾了两天才发现，好累，有时间写个简明教程。</p>
<p>linode测试的ubuntu16.04，iptables配置完后不能正常保存，重启后配置丢失，sugarhost ssd的最低配置，网络很溜，油管秒开，高清视频非常流畅，就是偶尔有不稳定的时候。</p>
</blockquote>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/干货/">干货</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/ubuntu/">ubuntu</a><a href="/tags/VPN/">VPN</a><a href="/tags/科学上网/">科学上网</a><a href="/tags/StrongSwan/">StrongSwan</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="www.kowen.cn/2017/09/14/Ubuntu16-04-安装StrongSwan-VPN教程/" data-title="Ubuntu16.04安装StrongSwan VPN教程 | Do cool things for fun" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2017/10/10/搭建你自己的私有云盘——Nextcloud配置教程/" title="搭建你自己的私有云盘——Nextcloud配置教程">
  <strong>上一篇：</strong><br/>
  <span>
  搭建你自己的私有云盘——Nextcloud配置教程</span>
</a>
</div>


<div class="next">
<a href="/2017/09/13/ubuntu-安装lighttpd/"  title="ubuntu安装lighttpd">
 <strong>下一篇：</strong><br/> 
 <span>ubuntu安装lighttpd
</span>
</a>
</div>

</nav>

	

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#介绍"><span class="toc-number">1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#前提"><span class="toc-number">2.</span> <span class="toc-text">前提</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一、安装strongSwan"><span class="toc-number">3.</span> <span class="toc-text">一、安装strongSwan</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、建立认证中心"><span class="toc-number">4.</span> <span class="toc-text">二、建立认证中心</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、为VPN服务器生成证书"><span class="toc-number">5.</span> <span class="toc-text">三、为VPN服务器生成证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、配置StrongSwan"><span class="toc-number">6.</span> <span class="toc-text">四、配置StrongSwan</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、配置VPN登录验证"><span class="toc-number">7.</span> <span class="toc-text">五、配置VPN登录验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六、配置防火墙和IP转发"><span class="toc-number">8.</span> <span class="toc-text">六、配置防火墙和IP转发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#七、测试连接"><span class="toc-number">9.</span> <span class="toc-text">七、测试连接</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#windows连接"><span class="toc-number">9.1.</span> <span class="toc-text">windows连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IOS连接"><span class="toc-number">9.2.</span> <span class="toc-text">IOS连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#macOS连接"><span class="toc-number">9.3.</span> <span class="toc-text">macOS连接</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常见问题"><span class="toc-number">10.</span> <span class="toc-text">常见问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">11.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#翻译结语"><span class="toc-number">12.</span> <span class="toc-text">翻译结语</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/git/" title="git">git<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/java/" title="java">java<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/linux/" title="linux">linux<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/python/" title="python">python<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/web前端/" title="web前端">web前端<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/干货/" title="干货">干货<sup>10</sup></a></li>
		  
		
		  
			<li><a href="/categories/数据库/" title="数据库">数据库<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/PyQt5/" title="PyQt5">PyQt5<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/python/" title="python">python<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/git/" title="git">git<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/lighttpd/" title="lighttpd">lighttpd<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/ubuntu/" title="ubuntu">ubuntu<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/网盘/" title="网盘">网盘<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/iptables/" title="iptables">iptables<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/nat/" title="nat">nat<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/firewall/" title="firewall">firewall<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/linux/" title="linux">linux<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/struts2/" title="struts2">struts2<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/主机头/" title="主机头">主机头<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/godaddy/" title="godaddy">godaddy<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/dnspod/" title="dnspod">dnspod<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/域名/" title="域名">域名<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/dwz/" title="dwz">dwz<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/上传/" title="上传">上传<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/mysql/" title="mysql">mysql<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/字符集/" title="字符集">字符集<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/编码/" title="编码">编码<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Enjoy life! <br/>
			Welcome to www.kowen.cn</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/1748948232" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:guangwen@outlook.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2019 
		
		<a href="/about" target="_blank" title="kowen">kowen</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#nothing"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>









<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Ff461cd29606b66590e7cad3a4905fb4c' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
